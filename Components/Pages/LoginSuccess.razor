@page "/login-success"
@using MyBarMenu.Client.Services.Interfaces
@inject NavigationManager Navigation
@inject IAuthService _authService
@rendermode InteractiveServer


<h3>Logged in successfully 🎉</h3>
<p>Redirecting to login...</p>

@code {
    private bool _hasRun;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasRun)
        {
            _hasRun = true;

            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("token", out var token))
            {
                //Got to here. Clear up null reference warnings
                if (string.IsNullOrWhiteSpace(token))
                {
                    Navigation.NavigateTo("/login-failure");
                    return;
                }

                await _authService.LoginAsync(token);

                await Task.Delay(2000);
                Navigation.NavigateTo("/app", forceLoad: true);
            }
            else
            {
                Navigation.NavigateTo("/login");
            }
        }
    }
}
